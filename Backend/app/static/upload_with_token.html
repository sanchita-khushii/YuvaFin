<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YuvaFin – Login, Upload & Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.35rem; }
    section { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
    label { display: block; margin-top: 0.5rem; font-weight: 500; }
    input[type="email"], input[type="password"] { width: 100%; padding: 0.5rem; box-sizing: border-box; }
    input[type="file"] { margin-top: 0.25rem; }
    button { margin-top: 0.75rem; padding: 0.5rem 1rem; cursor: pointer; background: #2563eb; color: white; border: none; border-radius: 6px; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    button.secondary { background: #0d9488; }
    .status { margin-top: 0.5rem; font-size: 0.875rem; color: #64748b; }
    .success { color: #15803d; }
    .error { color: #b91c1c; }
    #dashboardSummary { margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; white-space: pre-wrap; }
    #dashboardSummary:empty { display: none; }
  </style>
</head>
<body>
  <h1>YuvaFin – Test login, upload & dashboard</h1>
  <p>Log in once. The token is stored and sent with upload and dashboard requests so you can verify the API before building your frontend.</p>

  <section>
    <h2>1. Login</h2>
    <label>Email</label>
    <input type="email" id="email" placeholder="your@email.com" />
    <label>Password</label>
    <input type="password" id="password" placeholder="password" />
    <button type="button" id="btnLogin">Login</button>
    <div id="loginStatus" class="status"></div>
  </section>

  <section>
    <h2>2. Upload bill</h2>
    <label>Bill image</label>
    <input type="file" id="billFile" accept="image/*" />
    <button type="button" id="btnUpload" disabled>Upload bill</button>
    <div id="uploadStatus" class="status"></div>
  </section>

  <section>
    <h2>3. Dashboard (current month)</h2>
    <p>Load summary for the logged-in user: income, expenses, savings, category breakdown.</p>
    <button type="button" id="btnDashboard" class="secondary" disabled>Load dashboard</button>
    <div id="dashboardStatus" class="status"></div>
    <pre id="dashboardSummary"></pre>
  </section>

  <script>
    const API_BASE = '';  // same origin when opened via backend (e.g. http://localhost:8000)
    let token = localStorage.getItem('yuvafin_token') || '';

    function setStatus(elId, text, isError) {
      const el = document.getElementById(elId);
      el.textContent = text;
      el.className = 'status ' + (isError ? 'error' : 'success');
    }

    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) {
        setStatus('loginStatus', 'Enter email and password.', true);
        return;
      }
      setStatus('loginStatus', 'Logging in...');
      try {
        const res = await fetch(API_BASE + '/api/auth/login/json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (_) {}
        if (!res.ok) {
          setStatus('loginStatus', data.detail || text || 'Login failed', true);
          return;
        }
        token = data.access_token;
        if (!token) {
          setStatus('loginStatus', 'No token in response.', true);
          return;
        }
        localStorage.setItem('yuvafin_token', token);
        setStatus('loginStatus', 'Logged in. Token saved. You can upload bills and load the dashboard.');
        document.getElementById('btnUpload').disabled = false;
        document.getElementById('btnDashboard').disabled = false;
      } catch (e) {
        setStatus('loginStatus', 'Network error: ' + e.message, true);
      }
    };

    document.getElementById('btnUpload').onclick = async () => {
      const fileInput = document.getElementById('billFile');
      if (!fileInput.files.length) {
        setStatus('uploadStatus', 'Choose an image first.', true);
        return;
      }
      if (!token) {
        setStatus('uploadStatus', 'Login first to attach your account to the upload.', true);
        return;
      }
      setStatus('uploadStatus', 'Uploading...');
      const form = new FormData();
      form.append('files', fileInput.files[0]);
      try {
        const res = await fetch(API_BASE + '/api/expenses/upload-bill', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: form,
        });
        const text = await res.text();
        let data;
        try {
          data = text ? JSON.parse(text) : {};
        } catch (_) {
          setStatus('uploadStatus', res.ok ? 'Invalid response from server.' : ('Error: ' + (text || res.statusText)), true);
          return;
        }
        if (!res.ok) {
          const msg = Array.isArray(data.detail) ? data.detail.map(d => d.msg || d).join(', ') : (data.detail || 'Upload failed');
          setStatus('uploadStatus', msg, true);
          return;
        }
        const who = data.saved_for_email ? ` Saved for: ${data.saved_for_email}` : '';
        setStatus('uploadStatus', `Bill uploaded.${who} Expenses: ${JSON.stringify(data.expenses?.length || data.expenses)}`);
      } catch (e) {
        setStatus('uploadStatus', 'Network error: ' + e.message, true);
      }
    };

    document.getElementById('btnDashboard').onclick = async () => {
      if (!token) {
        setStatus('dashboardStatus', 'Login first.', true);
        return;
      }
      setStatus('dashboardStatus', 'Loading...');
      document.getElementById('dashboardSummary').textContent = '';
      try {
        const res = await fetch(API_BASE + '/api/dashboard/summary', {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token },
        });
        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (_) {}
        if (!res.ok) {
          setStatus('dashboardStatus', data.detail || text || 'Failed to load dashboard', true);
          return;
        }
        setStatus('dashboardStatus', 'Dashboard loaded.');
        const lines = [
          'Income: ' + (data.income != null ? data.income : '—'),
          'Total expense (this month): ' + (data.total_expense != null ? data.total_expense : '—'),
          'Savings: ' + (data.savings != null ? data.savings : '—'),
          'Savings %: ' + (data.savings_percentage != null ? data.savings_percentage : '—') + '%',
          'Financial status: ' + (data.financial_status || '—'),
          'Top category: ' + (data.top_spending_category || '—'),
          '',
          'Category breakdown:',
          ...(data.category_breakdown || []).map(c => '  ' + c.category + ': ' + c.amount + ' (' + c.percentage_of_income + '%)'),
          '',
          'Insights:',
          ...(data.insights || []).map(i => '  ' + i),
        ];
        document.getElementById('dashboardSummary').textContent = lines.join('\n');
      } catch (e) {
        setStatus('dashboardStatus', 'Network error: ' + e.message, true);
      }
    };

    if (token) {
      document.getElementById('loginStatus').textContent = 'You have a saved token. You can upload, load dashboard, or login again to switch user.';
      document.getElementById('btnUpload').disabled = false;
      document.getElementById('btnDashboard').disabled = false;
    }
  </script>
</body>
</html>
